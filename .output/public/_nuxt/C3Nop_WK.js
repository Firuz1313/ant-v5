import{r as p,I as y}from"./sX_wM5Ua.js";const R=()=>{const r=p([]),c=p(null),u=p(null),h=(t,s)=>{c.value=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,u.value=Date.now(),a({type:"session_start",deviceId:t,errorId:s,timestamp:Date.now(),userAgent:navigator.userAgent,screenResolution:`${screen.width}x${screen.height}`,viewport:`${window.innerWidth}x${window.innerHeight}`})},a=t=>{const s={id:Date.now()+Math.random(),sessionId:c.value,timestamp:Date.now(),...t};r.value.push(s);const e=localStorage.getItem("diagnostic_events")||"[]",n=JSON.parse(e);n.push(s),localStorage.setItem("diagnostic_events",JSON.stringify(n)),console.log("Event logged:",s)},f=(t,s,e,n={})=>{const o=n.timeOnStep;a({type:"step_action",stepId:t,stepTitle:s,action:e,timeOnStep:o||null,...n}),e==="viewed"&&o&&$(t,s,o)},S=(t,s,e=!0)=>{a({type:"button_press",buttonId:t,stepId:s,successful:e,timestamp:Date.now()})},w=(t,s,e,n={})=>{a({type:"user_choice",choiceType:t,choice:s,stepId:e,context:n})},_=(t,s,e={})=>{a({type:"error",errorMessage:t.message||t,errorStack:t.stack||null,stepId:s,context:e})},v=(t,s,e,n)=>{a({type:"diagnostic_completion",result:t,finalStepId:s,totalSteps:e,totalTime:n,completionRate:s/e}),D(t,s,e,n)},d=()=>{const t=r.value,s=t.filter(o=>o.type==="step_action"),e=t.filter(o=>o.type==="button_press"),n=t.filter(o=>o.type==="user_choice");return{sessionId:c.value,startTime:u.value,duration:Date.now()-(u.value||Date.now()),totalEvents:t.length,stepsViewed:s.filter(o=>o.action==="viewed").length,stepsCompleted:s.filter(o=>o.action==="completed").length,buttonPresses:e.length,successfulButtonPresses:e.filter(o=>o.successful).length,userChoices:n.length,lastActivity:Math.max(...t.map(o=>o.timestamp))}},m=(t="json")=>{const e={summary:d(),events:r.value};return t==="json"?JSON.stringify(e,null,2):t==="csv"?I(r.value):e},I=t=>{if(t.length===0)return"";const s=["timestamp","type","stepId","action","buttonId","choice","successful"],e=t.map(n=>[new Date(n.timestamp).toISOString(),n.type,n.stepId||"",n.action||"",n.buttonId||"",n.choice||"",n.successful!==void 0?n.successful:""]);return[s,...e].map(n=>n.join(",")).join(`
`)},O=(t="json")=>{const s=m(t),e=new Blob([s],{type:t==="json"?"application/json":"text/csv"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=`diagnostic_report_${c.value}.${t}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)},b=async()=>{if(r.value.length!==0)try{await $fetch("/api/analytics",{method:"POST",body:{sessionId:c.value,events:r.value,summary:d()}}),console.log("Analytics sent successfully")}catch(t){console.error("Failed to send analytics:",t)}},l=async(t,s)=>{try{await $fetch("/api/telegram/notify",{method:"POST",body:{type:t,data:s}})}catch(e){console.error("Failed to send Telegram notification:",e)}},$=async(t,s,e)=>{if(e>12e4){const o=r.value.find(i=>i.type==="session_start");await l("user_stuck",{sessionId:c.value,device:(o==null?void 0:o.deviceId)||"Неизвестно",error:(o==null?void 0:o.errorId)||"Неизвестно",stepTitle:s,timeStuck:g(e)})}},D=async(t,s,e,n)=>{const o=r.value.find(k=>k.type==="session_start"),i=t==="success";await l("diagnostic_completed",{sessionId:c.value,device:(o==null?void 0:o.deviceId)||"Неизвестно",error:(o==null?void 0:o.errorId)||"Неизвестно",success:i,duration:g(n),stepsCompleted:s,totalSteps:e})},T=async(t="medium",s="",e="1-2 часа")=>{const n=r.value.find(i=>i.type==="session_start"),o=`req_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;return a({type:"master_request",requestId:o,priority:t,contact:s,estimatedArrival:e}),await l("master_request",{requestId:o,device:(n==null?void 0:n.deviceId)||"Неизвестно",error:(n==null?void 0:n.errorId)||"Неизвестно",priority:t,contact:s,estimatedArrival:e}),o},g=t=>{const s=Math.floor(t/6e4),e=Math.floor(t%(1e3*60)/1e3);return s>0?`${s} мин ${e} сек`:`${e} сек`},C=()=>{const t=r.value.filter(e=>e.type==="step_action"),s=[];return t.forEach(e=>{e.timeOnStep&&e.timeOnStep>6e4&&s.push({stepId:e.stepId,stepTitle:e.stepTitle,timeSpent:e.timeOnStep,timestamp:e.timestamp})}),s},E=(t=7)=>{const s=Date.now()-t*24*60*60*1e3,e=localStorage.getItem("diagnostic_events")||"[]",o=JSON.parse(e).filter(i=>i.timestamp>s);localStorage.setItem("diagnostic_events",JSON.stringify(o))};return{userEvents:y(r),sessionId:y(c),initSession:h,logEvent:a,logStepEvent:f,logButtonPress:S,logUserChoice:w,logError:_,logCompletion:v,getSessionSummary:d,exportSessionData:m,downloadReport:O,sendAnalytics:b,getStuckAnalysis:C,cleanupOldEvents:E,requestMaster:T,sendTelegramNotification:l}};export{R as u};
